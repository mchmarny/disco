package bq

import (
	"context"
	"time"

	"cloud.google.com/go/bigquery"
	"github.com/mchmarny/disco/pkg/scanner"
	"github.com/mchmarny/disco/pkg/types"
	"github.com/pkg/errors"
	"github.com/rs/zerolog/log"
)

func ImportVulnerabilities(ctx context.Context, req *types.ImportRequest) error {
	if req == nil || req.FilePath == "" {
		return errors.Errorf("configured import request is required: %v", req)
	}

	f := func(v interface{}) bool {
		return false
	}

	var reports []*types.VulnerabilityReport

	switch req.VulnFormat {
	case types.VulnReportFormatTrivy:
		report, err := scanner.ParseVulnerability(req.FilePath, f)
		if err != nil {
			return errors.Wrapf(err, "failed to parse report from %s", req.FilePath)
		}
		reports = append(reports, report)
	case types.VulnReportFormatDisco:
		var itemReport types.ItemReport[types.VulnerabilityReport]
		if err := types.UnmarshalFromFile(req.FilePath, &itemReport); err != nil {
			return errors.Wrapf(err, "failed to parse report from %s", req.FilePath)
		}
		reports = itemReport.Items
	default:
		return errors.Errorf("unsupported vulnerability report format: %s", req.VulnFormat)
	}

	if err := configureTarget(ctx, req); err != nil {
		return errors.Wrap(err, "errors checking target configuration")
	}

	rows := MakeVulnerabilityRows(reports...)
	if err := insert(ctx, req, rows); err != nil {
		return errors.Wrap(err, "failed to insert rows")
	}

	log.Debug().Msgf("inserted %d records into %s.%s.%s", len(rows), req.ProjectID, req.DatasetID, req.TableID)

	return nil
}

func MakeVulnerabilityRows(in ...*types.VulnerabilityReport) []*VulnerabilityRow {
	list := make([]*VulnerabilityRow, 0)
	updated := time.Now().UTC().Format(time.RFC3339)
	batchID := time.Now().UTC().Unix()

	for _, r := range in {
		for _, v := range r.Vulnerabilities {
			log.Info().Msgf("adding vulnerability %s in %s", v.ID, v.Package)
			list = append(list, &VulnerabilityRow{
				BatchID:        batchID,
				Image:          types.ParseImageNameFromDigest(r.Image),
				Sha:            types.ParseImageShaFromDigest(r.Image),
				CVE:            v.ID,
				Severity:       v.Severity,
				Package:        v.Package,
				PackageVersion: v.PackageVersion,
				Title:          v.Title,
				Description:    v.Description,
				URL:            v.URL,
				Updated:        updated,
			})
		}
	}

	return list
}

type VulnerabilityRow struct {
	BatchID        int64
	Image          string
	Sha            string
	CVE            string
	Severity       string
	Package        string
	PackageVersion string
	Title          string
	Description    string
	URL            string
	Updated        string
}

func (i *VulnerabilityRow) Save() (map[string]bigquery.Value, string, error) {
	return map[string]bigquery.Value{
		"batch_id":    i.BatchID,
		"image":       i.Image,
		"sha":         i.Sha,
		"cve":         i.CVE,
		"severity":    i.Severity,
		"package":     i.Package,
		"version":     i.PackageVersion,
		"title":       i.Title,
		"description": i.Description,
		"url":         i.URL,
		"updated":     i.Updated,
	}, "", nil
}
